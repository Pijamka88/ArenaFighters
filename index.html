<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Street Escape - Пошаговая погоня</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        
        #game-container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
        }
        
        #game-map {
            width: 100%;
            height: 300px;
            background-color: #1e1e1e;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #333;
        }
        
        .cell {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #2a2a2a;
            border: 1px solid #333;
            box-sizing: border-box;
        }
        
        .road {
            background-color: #333;
        }
        
        .player {
            background-color: #4CAF50;
            border-radius: 50%;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
        }
        
        .police {
            background-color: #f44336;
            border-radius: 50%;
            z-index: 9;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
        }
        
        .obstacle {
            background-color: #555;
            border-radius: 4px;
        }
        
        #game-info {
            width: 100%;
            background-color: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #333;
        }
        
        #stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .stat-label {
            font-size: 12px;
            color: #aaa;
        }
        
        #message-log {
            height: 80px;
            overflow-y: auto;
            background-color: #252525;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .message {
            margin: 3px 0;
            padding: 2px 0;
            border-bottom: 1px solid #333;
        }
        
        #controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 5px;
            width: 100%;
            max-width: 300px;
            margin-bottom: 15px;
        }
        
        .control-btn {
            background-color: #333;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 12px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .control-btn:hover {
            background-color: #444;
        }
        
        .control-btn:active {
            background-color: #555;
        }
        
        #up-btn {
            grid-column: 2;
            grid-row: 1;
        }
        
        #left-btn {
            grid-column: 1;
            grid-row: 2;
        }
        
        #right-btn {
            grid-column: 3;
            grid-row: 2;
        }
        
        #down-btn {
            grid-column: 2;
            grid-row: 3;
        }
        
        #boost-btn {
            grid-column: 1 / span 3;
            grid-row: 4;
            background-color: #FF9800;
        }
        
        #boost-btn:hover {
            background-color: #F57C00;
        }
        
        #start-screen, #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .screen-content {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            max-width: 80%;
            text-align: center;
            border: 2px solid #333;
        }
        
        .screen-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #4CAF50;
        }
        
        .screen-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 15px;
            transition: background-color 0.3s;
        }
        
        .screen-btn:hover {
            background-color: #45a049;
        }
        
        #game-over-screen {
            display: none;
        }
        
        @media (max-height: 700px) {
            #game-map {
                height: 250px;
            }
            
            #message-log {
                height: 60px;
            }
        }
        
        @media (max-height: 600px) {
            #game-map {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="game-map"></div>
        
        <div id="game-info">
            <div id="stats">
                <div class="stat">
                    <span class="stat-value" id="speed-value">1</span>
                    <span class="stat-label">СКОРОСТЬ</span>
                </div>
                <div class="stat">
                    <span class="stat-value" id="distance-value">0</span>
                    <span class="stat-label">ДИСТАНЦИЯ</span>
                </div>
                <div class="stat">
                    <span class="stat-value" id="boost-value">3</span>
                    <span class="stat-label">УСКОРЕНИЕ</span>
                </div>
            </div>
            
            <div id="message-log"></div>
        </div>
        
        <div id="controls">
            <button class="control-btn" id="up-btn">↑</button>
            <button class="control-btn" id="left-btn">←</button>
            <button class="control-btn" id="right-btn">→</button>
            <button class="control-btn" id="down-btn">↓</button>
            <button class="control-btn" id="boost-btn">ТУРБО (3)</button>
        </div>
    </div>
    
    <div id="start-screen">
        <div class="screen-content">
            <div class="screen-title">STREET ESCAPE</div>
            <p>Убегайте от полиции по улицам города!</p>
            <p>Используйте кнопки для управления. Турбо ускоряет вас, но ограничено.</p>
            <p>Набирайте скорость, чтобы уйти от погони!</p>
            <button class="screen-btn" id="start-btn">НАЧАТЬ ГОНКУ</button>
        </div>
    </div>
    
    <div id="game-over-screen">
        <div class="screen-content">
            <div class="screen-title">ПОЙМАНЫ!</div>
            <p>Ваш результат: <span id="final-distance">0</span> метров</p>
            <p>Максимальная скорость: <span id="final-speed">0</span></p>
            <button class="screen-btn" id="restart-btn">ГОНКА СНОВА</button>
        </div>
    </div>
    
    <script>
        // Конфигурация игры
        const config = {
            mapSize: { width: 15, height: 10 },
            cellSize: 30,
            playerSpeed: 1,
            maxSpeed: 5,
            boostAmount: 3,
            boostSpeed: 3,
            policeSpeed: 1,
            policeSpawnRate: 0.3,
            minPoliceDistance: 5,
            roadDensity: 0.6,
            turnProbability: 0.3,
            messageLimit: 5
        };
        
        // Состояние игры
        const state = {
            playerPos: { x: 0, y: 0 },
            police: [],
            roads: [],
            obstacles: [],
            speed: 1,
            distance: 0,
            boosts: config.boostAmount,
            isGameOver: false,
            turnDirection: null,
            lastDirection: 'right',
            messages: []
        };
        
        // DOM элементы
        const elements = {
            gameMap: document.getElementById('game-map'),
            speedValue: document.getElementById('speed-value'),
            distanceValue: document.getElementById('distance-value'),
            boostValue: document.getElementById('boost-value'),
            messageLog: document.getElementById('message-log'),
            upBtn: document.getElementById('up-btn'),
            leftBtn: document.getElementById('left-btn'),
            rightBtn: document.getElementById('right-btn'),
            downBtn: document.getElementById('down-btn'),
            boostBtn: document.getElementById('boost-btn'),
            startScreen: document.getElementById('start-screen'),
            gameOverScreen: document.getElementById('game-over-screen'),
            startBtn: document.getElementById('start-btn'),
            restartBtn: document.getElementById('restart-btn'),
            finalDistance: document.getElementById('final-distance'),
            finalSpeed: document.getElementById('final-speed')
        };
        
        // Инициализация игры
        function initGame() {
            // Установка размеров игрового поля
            elements.gameMap.style.width = `${config.mapSize.width * config.cellSize}px`;
            elements.gameMap.style.height = `${config.mapSize.height * config.cellSize}px`;
            
            // Генерация дорог
            generateRoads();
            
            // Размещение игрока
            placePlayer();
            
            // Отрисовка карты
            renderMap();
            
            // Обновление UI
            updateUI();
            
            // Начальное сообщение
            addMessage('Гонка началась! Убегайте от полиции!');
        }
        
        // Генерация дорожной сети
        function generateRoads() {
            state.roads = [];
            state.obstacles = [];
            
            // Начинаем с левого края по центру
            let startY = Math.floor(config.mapSize.height / 2);
            let currentX = 0;
            let currentY = startY;
            let direction = 'right';
            
            // Пока не дойдем до правого края
            while (currentX < config.mapSize.width) {
                // Добавляем текущую клетку как дорогу
                state.roads.push({ x: currentX, y: currentY });
                
                // Решаем, поворачивать ли
                if (Math.random() < config.turnProbability && currentX > 0 && currentX < config.mapSize.width - 1) {
                    if (direction === 'right') {
                        // Выбираем направление поворота
                        const turn = Math.random() < 0.5 ? 'up' : 'down';
                        
                        // Проверяем, можно ли повернуть
                        if (turn === 'up' && currentY > 0) {
                            direction = 'up';
                        } else if (turn === 'down' && currentY < config.mapSize.height - 1) {
                            direction = 'down';
                        }
                    } else {
                        // Возвращаемся к движению вправо
                        direction = 'right';
                    }
                }
                
                // Двигаемся в выбранном направлении
                if (direction === 'right') {
                    currentX++;
                } else if (direction === 'up') {
                    currentY--;
                } else if (direction === 'down') {
                    currentY++;
                }
            }
            
            // Добавляем случайные дороги для заполнения
            const targetRoadCells = Math.floor(config.mapSize.width * config.mapSize.height * config.roadDensity);
            while (state.roads.length < targetRoadCells) {
                const x = Math.floor(Math.random() * config.mapSize.width);
                const y = Math.floor(Math.random() * config.mapSize.height);
                
                // Проверяем, есть ли рядом дороги
                const hasNeighborRoad = [
                    {x: x-1, y},
                    {x: x+1, y},
                    {x, y: y-1},
                    {x, y: y+1}
                ].some(pos => state.roads.some(road => road.x === pos.x && road.y === pos.y));
                
                if (hasNeighborRoad && !state.roads.some(road => road.x === x && road.y === y)) {
                    state.roads.push({ x, y });
                }
            }
            
            // Добавляем препятствия (не на дорогах)
            for (let x = 0; x < config.mapSize.width; x++) {
                for (let y = 0; y < config.mapSize.height; y++) {
                    if (!state.roads.some(road => road.x === x && road.y === y) && Math.random() < 0.3) {
                        state.obstacles.push({ x, y });
                    }
                }
            }
        }
        
        // Размещение игрока на карте
        function placePlayer() {
            // Находим самую левую дорогу в среднем ряду
            const startY = Math.floor(config.mapSize.height / 2);
            let startX = 0;
            
            while (startX < config.mapSize.width && 
                  !state.roads.some(road => road.x === startX && road.y === startY)) {
                startX++;
            }
            
            if (startX >= config.mapSize.width) {
                // Если не нашли в среднем ряду, берем первую доступную дорогу
                const firstRoad = state.roads.sort((a, b) => a.x - b.x)[0];
                startX = firstRoad.x;
                state.playerPos = { x: firstRoad.x, y: firstRoad.y };
            } else {
                state.playerPos = { x: startX, y: startY };
            }
            
            state.lastDirection = 'right';
            state.turnDirection = null;
        }
        
        // Отрисовка карты
        function renderMap() {
            elements.gameMap.innerHTML = '';
            
            // Отрисовка клеток
            for (let x = 0; x < config.mapSize.width; x++) {
                for (let y = 0; y < config.mapSize.height; y++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.style.left = `${x * config.cellSize}px`;
                    cell.style.top = `${y * config.cellSize}px`;
                    
                    // Проверяем тип клетки
                    if (state.roads.some(road => road.x === x && road.y === y)) {
                        cell.classList.add('road');
                    } else if (state.obstacles.some(obs => obs.x === x && obs.y === y)) {
                        cell.classList.add('obstacle');
                    }
                    
                    elements.gameMap.appendChild(cell);
                }
            }
            
            // Отрисовка полиции
            state.police.forEach((police, index) => {
                const policeElement = document.createElement('div');
                policeElement.className = 'police';
                policeElement.style.left = `${police.x * config.cellSize}px`;
                policeElement.style.top = `${police.y * config.cellSize}px`;
                policeElement.textContent = 'P';
                elements.gameMap.appendChild(policeElement);
            });
            
            // Отрисовка игрока
            const playerElement = document.createElement('div');
            playerElement.className = 'player';
            playerElement.style.left = `${state.playerPos.x * config.cellSize}px`;
            playerElement.style.top = `${state.playerPos.y * config.cellSize}px`;
            playerElement.textContent = 'Y';
            elements.gameMap.appendChild(playerElement);
        }
        
        // Обновление UI
        function updateUI() {
            elements.speedValue.textContent = state.speed;
            elements.distanceValue.textContent = state.distance;
            elements.boostValue.textContent = state.boosts;
            elements.boostBtn.textContent = `ТУРБО (${state.boosts})`;
            
            // Очищаем сообщения
            elements.messageLog.innerHTML = '';
            
            // Добавляем последние сообщения
            const recentMessages = state.messages.slice(-config.messageLimit);
            recentMessages.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                messageElement.textContent = msg;
                elements.messageLog.appendChild(messageElement);
            });
            
            // Прокручиваем вниз
            elements.messageLog.scrollTop = elements.messageLog.scrollHeight;
        }
        
        // Добавление сообщения в лог
        function addMessage(text) {
            state.messages.push(text);
            updateUI();
        }
        
        // Движение игрока
        function movePlayer(direction) {
            if (state.isGameOver) return;
            
            let newX = state.playerPos.x;
            let newY = state.playerPos.y;
            let moved = false;
            
            // Определяем новую позицию
            if (direction === 'up' && state.playerPos.y > 0) {
                newY--;
                moved = true;
                state.lastDirection = 'up';
            } else if (direction === 'down' && state.playerPos.y < config.mapSize.height - 1) {
                newY++;
                moved = true;
                state.lastDirection = 'down';
            } else if (direction === 'left' && state.playerPos.x > 0) {
                newX--;
                moved = true;
                state.lastDirection = 'left';
            } else if (direction === 'right' && state.playerPos.x < config.mapSize.width - 1) {
                newX++;
                moved = true;
                state.lastDirection = 'right';
            }
            
            // Проверяем, можно ли переместиться
            if (moved) {
                // Проверяем, что новая позиция - это дорога и не препятствие
                const isRoad = state.roads.some(road => road.x === newX && road.y === newY);
                const isObstacle = state.obstacles.some(obs => obs.x === newX && obs.y === newY);
                
                if (isRoad && !isObstacle) {
                    state.playerPos.x = newX;
                    state.playerPos.y = newY;
                    state.distance += state.speed;
                    
                    // Увеличиваем скорость со временем
                    if (Math.random() < 0.2 && state.speed < config.maxSpeed) {
                        state.speed++;
                        addMessage(`Скорость увеличилась до ${state.speed}!`);
                    }
                    
                    // Полиция двигается
                    movePolice();
                    
                    // Спавн новой полиции
                    if (Math.random() < config.policeSpawnRate) {
                        spawnPolice();
                    }
                    
                    // Проверка столкновений
                    checkCollisions();
                    
                    // Отрисовка обновлений
                    renderMap();
                    updateUI();
                } else {
                    addMessage('Нельзя ехать через препятствия!');
                }
            }
        }
        
        // Движение полиции
        function movePolice() {
            state.police.forEach(police => {
                const directions = [];
                
                // Определяем возможные направления движения
                if (police.x > 0) directions.push('left');
                if (police.x < config.mapSize.width - 1) directions.push('right');
                if (police.y > 0) directions.push('up');
                if (police.y < config.mapSize.height - 1) directions.push('down');
                
                // Фильтруем направления, чтобы полиция двигалась по дорогам
                const validDirections = directions.filter(dir => {
                    let checkX = police.x;
                    let checkY = police.y;
                    
                    if (dir === 'left') checkX--;
                    else if (dir === 'right') checkX++;
                    else if (dir === 'up') checkY--;
                    else if (dir === 'down') checkY++;
                    
                    return state.roads.some(road => road.x === checkX && road.y === checkY);
                });
                
                if (validDirections.length > 0) {
                    // Полиция пытается приблизиться к игроку
                    let bestDir = validDirections[0];
                    let bestDist = Infinity;
                    
                    validDirections.forEach(dir => {
                        let testX = police.x;
                        let testY = police.y;
                        
                        if (dir === 'left') testX--;
                        else if (dir === 'right') testX++;
                        else if (dir === 'up') testY--;
                        else if (dir === 'down') testY++;
                        
                        const dist = Math.sqrt(
                            Math.pow(testX - state.playerPos.x, 2) + 
                            Math.pow(testY - state.playerPos.y, 2)
                        );
                        
                        if (dist < bestDist) {
                            bestDist = dist;
                            bestDir = dir;
                        }
                    });
                    
                    // Двигаем полицию
                    if (Math.random() < 0.7) { // 70% шанс двигаться оптимально
                        if (bestDir === 'left') police.x--;
                        else if (bestDir === 'right') police.x++;
                        else if (bestDir === 'up') police.y--;
                        else if (bestDir === 'down') police.y++;
                    } else { // 30% шанс двигаться случайно
                        const randomDir = validDirections[Math.floor(Math.random() * validDirections.length)];
                        if (randomDir === 'left') police.x--;
                        else if (randomDir === 'right') police.x++;
                        else if (randomDir === 'up') police.y--;
                        else if (randomDir === 'down') police.y++;
                    }
                }
            });
        }
        
        // Спавн новой полиции
        function spawnPolice() {
            // Находим все дороги на достаточном расстоянии от игрока
            const validRoads = state.roads.filter(road => {
                const distToPlayer = Math.sqrt(
                    Math.pow(road.x - state.playerPos.x, 2) + 
                    Math.pow(road.y - state.playerPos.y, 2)
                );
                
                return distToPlayer >= config.minPoliceDistance && 
                       !state.police.some(p => p.x === road.x && p.y === road.y) &&
                       !(road.x === state.playerPos.x && road.y === state.playerPos.y);
            });
            
            if (validRoads.length > 0) {
                const spawnPoint = validRoads[Math.floor(Math.random() * validRoads.length)];
                state.police.push({ x: spawnPoint.x, y: spawnPoint.y });
                addMessage('Появилась новая полицейская машина!');
            }
        }
        
        // Проверка столкновений
        function checkCollisions() {
            state.police.forEach(police => {
                if (police.x === state.playerPos.x && police.y === state.playerPos.y) {
                    gameOver();
                }
            });
        }
        
        // Использование турбо
        function useBoost() {
            if (state.isGameOver) return;
            
            if (state.boosts > 0) {
                state.boosts--;
                const boostDistance = state.speed * config.boostSpeed;
                state.distance += boostDistance;
                state.speed = Math.min(state.speed + 1, config.maxSpeed);
                
                addMessage(`Турбо ускоритель! +${boostDistance} метров!`);
                
                // Двигаем игрока вперед на несколько клеток
                let movesLeft = config.boostSpeed;
                let currentX = state.playerPos.x;
                let currentY = state.playerPos.y;
                
                while (movesLeft > 0) {
                    let newX = currentX;
                    let newY = currentY;
                    
                    // Двигаемся в последнем направлении
                    if (state.lastDirection === 'up' && currentY > 0) {
                        newY--;
                    } else if (state.lastDirection === 'down' && currentY < config.mapSize.height - 1) {
                        newY++;
                    } else if (state.lastDirection === 'left' && currentX > 0) {
                        newX--;
                    } else if (state.lastDirection === 'right' && currentX < config.mapSize.width - 1) {
                        newX++;
                    }
                    
                    // Проверяем, можно ли переместиться
                    const isRoad = state.roads.some(road => road.x === newX && road.y === newY);
                    const isObstacle = state.obstacles.some(obs => obs.x === newX && obs.y === newY);
                    
                    if (isRoad && !isObstacle && (newX !== currentX || newY !== currentY)) {
                        currentX = newX;
                        currentY = newY;
                        movesLeft--;
                    } else {
                        break;
                    }
                }
                
                state.playerPos.x = currentX;
                state.playerPos.y = currentY;
                
                // Полиция двигается несколько раз
                for (let i = 0; i < config.boostSpeed; i++) {
                    movePolice();
                }
                
                // Спавн полиции
                if (Math.random() < config.policeSpawnRate * 2) {
                    spawnPolice();
                }
                
                // Проверка столкновений
                checkCollisions();
                
                // Отрисовка обновлений
                renderMap();
                updateUI();
            } else {
                addMessage('Нет ускорителей!');
            }
        }
        
        // Конец игры
        function gameOver() {
            state.isGameOver = true;
            elements.finalDistance.textContent = state.distance;
            elements.finalSpeed.textContent = state.speed;
            elements.gameOverScreen.style.display = 'flex';
            addMessage('Вас поймала полиция! Игра окончена.');
        }
        
        // Начало новой игры
        function startGame() {
            // Сброс состояния
            state.playerPos = { x: 0, y: 0 };
            state.police = [];
            state.speed = config.playerSpeed;
            state.distance = 0;
            state.boosts = config.boostAmount;
            state.isGameOver = false;
            state.turnDirection = null;
            state.lastDirection = 'right';
            state.messages = [];
            
            // Генерация карты
            generateRoads();
            placePlayer();
            
            // Спавн начальной полиции
            spawnPolice();
            
            // Отрисовка
            renderMap();
            updateUI();
            
            // Скрытие экрана старта
            elements.startScreen.style.display = 'none';
            elements.gameOverScreen.style.display = 'none';
            
            addMessage('Гонка началась! Убегайте от полиции!');
        }
        
        // Обработчики событий
        elements.upBtn.addEventListener('click', () => movePlayer('up'));
        elements.downBtn.addEventListener('click', () => movePlayer('down'));
        elements.leftBtn.addEventListener('click', () => movePlayer('left'));
        elements.rightBtn.addEventListener('click', () => movePlayer('right'));
        elements.boostBtn.addEventListener('click', useBoost);
        elements.startBtn.addEventListener('click', startGame);
        elements.restartBtn.addEventListener('click', startGame);
        
        // Обработчики клавиатуры
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowUp') movePlayer('up');
            else if (e.key === 'ArrowDown') movePlayer('down');
            else if (e.key === 'ArrowLeft') movePlayer('left');
            else if (e.key === 'ArrowRight') movePlayer('right');
            else if (e.key === ' ' || e.key === 'Spacebar') useBoost();
        });
        
        // Инициализация при загрузке
        window.addEventListener('load', initGame);
    </script>
</body>
</html>