<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Побег от полиции</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            touch-action: manipulation;
        }
        #game-container {
            max-width: 500px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        #game-board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            gap: 1px;
            background-color: #333;
            width: 100%;
            aspect-ratio: 1/1;
            margin: 20px 0;
        }
        .cell {
            background-color: #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            position: relative;
        }
        .road {
            background-color: #aaa;
        }
        .player {
            background-color: #4CAF50;
            color: white;
            border-radius: 50%;
            width: 80%;
            height: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        .police {
            background-color: #f44336;
            color: white;
            border-radius: 50%;
            width: 80%;
            height: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        .intersection {
            background-color: #888;
        }
        .traffic-light {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #ffeb3b;
            top: 2px;
            left: 2px;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 10px 15px;
            margin: 0 5px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
        button:disabled {
            background-color: #cccccc;
        }
        #stats {
            margin: 10px 0;
            font-size: 18px;
        }
        #message {
            font-size: 20px;
            font-weight: bold;
            margin: 10px 0;
            min-height: 30px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>Побег от полиции</h1>
        <div id="stats">
            Ходов: <span id="turns">0</span> |
            Полиция 1: <span id="police1-dist">-</span> |
            Полиция 2: <span id="police2-dist">-</span>
        </div>
        <div id="message"></div>
        <div id="game-board"></div>
        <div class="controls">
            <button id="btn-up" disabled>↑</button><br>
            <button id="btn-left" disabled>←</button>
            <button id="btn-forward" disabled>Прямо</button>
            <button id="btn-right" disabled>→</button><br>
            <button id="btn-start">Начать игру</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Константы игры
            const BOARD_SIZE = 10;
            const PLAYER_CHAR = 'Я';
            const POLICE_CHAR = 'П';
            
            // Элементы DOM
            const gameBoard = document.getElementById('game-board');
            const turnsDisplay = document.getElementById('turns');
            const police1Dist = document.getElementById('police1-dist');
            const police2Dist = document.getElementById('police2-dist');
            const messageDisplay = document.getElementById('message');
            const btnUp = document.getElementById('btn-up');
            const btnLeft = document.getElementById('btn-left');
            const btnForward = document.getElementById('btn-forward');
            const btnRight = document.getElementById('btn-right');
            const btnStart = document.getElementById('btn-start');
            
            // Состояние игры
            let gameState = {
                playerPos: { x: 0, y: 0 },
                policePos: [{ x: 0, y: 0 }, { x: 0, y: 0 }],
                playerDirection: 'right', // 'up', 'down', 'left', 'right'
                turns: 0,
                isMoving: false,
                gameOver: false,
                roadMap: []
            };
            
            // Инициализация игрового поля
            function initBoard() {
                gameBoard.innerHTML = '';
                gameBoard.style.gridTemplateColumns = `repeat(${BOARD_SIZE}, 1fr)`;
                gameBoard.style.gridTemplateRows = `repeat(${BOARD_SIZE}, 1fr)`;
                
                // Создаем дорожную сеть (простой городской план)
                const roadMap = Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(0));
                
                // Главные дороги
                for (let i = 0; i < BOARD_SIZE; i++) {
                    // Горизонтальные дороги через каждые 2 строки
                    if (i % 2 === 1) {
                        for (let j = 0; j < BOARD_SIZE; j++) {
                            roadMap[i][j] = 1;
                        }
                    }
                    
                    // Вертикальные дороги через каждые 3 колонки
                    if (i % 3 === 1) {
                        for (let j = 0; j < BOARD_SIZE; j++) {
                            if (roadMap[j][i] === 0) roadMap[j][i] = 1;
                            else roadMap[j][i] = 2; // Перекресток
                        }
                    }
                }
                
                gameState.roadMap = roadMap;
                
                // Создаем клетки
                for (let y = 0; y < BOARD_SIZE; y++) {
                    for (let x = 0; x < BOARD_SIZE; x++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.id = `cell-${x}-${y}`;
                        
                        if (roadMap[y][x] === 1) {
                            cell.classList.add('road');
                        } else if (roadMap[y][x] === 2) {
                            cell.classList.add('intersection');
                            const light = document.createElement('div');
                            light.className = 'traffic-light';
                            cell.appendChild(light);
                        }
                        
                        gameBoard.appendChild(cell);
                    }
                }
            }
            
            // Начальная позиция игрока и полиции
            function initPositions() {
                gameState.playerPos = { x: 1, y: BOARD_SIZE - 2 };
                gameState.playerDirection = 'right';
                
                // Полиция в разных углах
                gameState.policePos[0] = { x: BOARD_SIZE - 2, y: 1 };
                gameState.policePos[1] = { x: 1, y: 1 };
                
                gameState.turns = 0;
                gameState.isMoving = false;
                gameState.gameOver = false;
                
                turnsDisplay.textContent = '0';
                messageDisplay.textContent = '';
            }
            
            // Отрисовка игрового состояния
            function render() {
                // Очищаем все клетки от игрока и полиции
                document.querySelectorAll('.player, .police').forEach(el => el.remove());
                
                // Рисуем игрока
                const playerCell = document.getElementById(`cell-${gameState.playerPos.x}-${gameState.playerPos.y}`);
                if (playerCell) {
                    const player = document.createElement('div');
                    player.className = 'player';
                    player.textContent = PLAYER_CHAR;
                    playerCell.appendChild(player);
                }
                
                // Рисуем полицию
                gameState.policePos.forEach((pos, index) => {
                    const policeCell = document.getElementById(`cell-${pos.x}-${pos.y}`);
                    if (policeCell) {
                        const police = document.createElement('div');
                        police.className = 'police';
                        police.textContent = POLICE_CHAR + (index + 1);
                        policeCell.appendChild(police);
                    }
                });
                
                // Обновляем статистику
                police1Dist.textContent = distance(gameState.playerPos, gameState.policePos[0]);
                police2Dist.textContent = distance(gameState.playerPos, gameState.policePos[1]);
            }
            
            // Расчет расстояния между двумя точками
            function distance(pos1, pos2) {
                return Math.abs(pos1.x - pos2.x) + Math.abs(pos1.y - pos2.y);
            }
            
            // Проверка на столкновение с полицией
            function checkCollision() {
                return gameState.policePos.some(policePos => 
                    policePos.x === gameState.playerPos.x && policePos.y === gameState.playerPos.y
                );
            }
            
            // Ход игрока
            async function playerMove(direction) {
                if (gameState.gameOver || !gameState.isMoving) return;
                
                // Изменяем направление если поворачиваем
                if (direction === 'left') {
                    gameState.playerDirection = turnLeft(gameState.playerDirection);
                } else if (direction === 'right') {
                    gameState.playerDirection = turnRight(gameState.playerDirection);
                }
                
                // Двигаемся вперед
                const newPos = calculateNewPosition(gameState.playerPos, gameState.playerDirection);
                
                // Проверяем, можем ли мы двигаться в этом направлении (есть ли дорога)
                if (isValidMove(newPos)) {
                    gameState.playerPos = newPos;
                    gameState.turns++;
                    turnsDisplay.textContent = gameState.turns;
                    
                    render();
                    
                    // Проверяем столкновение
                    if (checkCollision()) {
                        endGame(false);
                        return;
                    }
                    
                    // Если мы на перекрестке, ждем выбора направления
                    if (isIntersection(gameState.playerPos)) {
                        await waitAtIntersection();
                    }
                    
                    // Ход полиции
                    policeMove();
                    
                    // Снова проверяем столкновение после хода полиции
                    if (checkCollision()) {
                        endGame(false);
                    }
                }
            }
            
            // Поворот налево
            function turnLeft(currentDirection) {
                const directions = ['up', 'left', 'down', 'right'];
                const currentIndex = directions.indexOf(currentDirection);
                return directions[(currentIndex + 1) % directions.length];
            }
            
            // Поворот направо
            function turnRight(currentDirection) {
                const directions = ['up', 'right', 'down', 'left'];
                const currentIndex = directions.indexOf(currentDirection);
                return directions[(currentIndex + 1) % directions.length];
            }
            
            // Расчет новой позиции
            function calculateNewPosition(pos, direction) {
                const newPos = { ...pos };
                
                switch (direction) {
                    case 'up': newPos.y--; break;
                    case 'down': newPos.y++; break;
                    case 'left': newPos.x--; break;
                    case 'right': newPos.x++; break;
                }
                
                return newPos;
            }
            
            // Проверка валидности хода
            function isValidMove(pos) {
                return pos.x >= 0 && pos.x < BOARD_SIZE && 
                       pos.y >= 0 && pos.y < BOARD_SIZE && 
                       gameState.roadMap[pos.y][pos.x] > 0;
            }
            
            // Проверка, находится ли позиция на перекрестке
            function isIntersection(pos) {
                return gameState.roadMap[pos.y][pos.x] === 2;
            }
            
            // Ожидание выбора на перекрестке
            function waitAtIntersection() {
                return new Promise(resolve => {
                    // Активируем кнопки для выбора направления
                    btnForward.disabled = false;
                    btnLeft.disabled = false;
                    btnRight.disabled = false;
                    
                    // Ждем, пока игрок не сделает выбор
                    const handleMove = (direction) => {
                        btnForward.disabled = true;
                        btnLeft.disabled = true;
                        btnRight.disabled = true;
                        
                        resolve(direction);
                    };
                    
                    const forwardHandler = () => {
                        handleMove('forward');
                        btnForward.removeEventListener('click', forwardHandler);
                        btnLeft.removeEventListener('click', leftHandler);
                        btnRight.removeEventListener('click', rightHandler);
                    };
                    
                    const leftHandler = () => {
                        handleMove('left');
                        btnForward.removeEventListener('click', forwardHandler);
                        btnLeft.removeEventListener('click', leftHandler);
                        btnRight.removeEventListener('click', rightHandler);
                    };
                    
                    const rightHandler = () => {
                        handleMove('right');
                        btnForward.removeEventListener('click', forwardHandler);
                        btnLeft.removeEventListener('click', leftHandler);
                        btnRight.removeEventListener('click', rightHandler);
                    };
                    
                    btnForward.addEventListener('click', forwardHandler);
                    btnLeft.addEventListener('click', leftHandler);
                    btnRight.addEventListener('click', rightHandler);
                });
            }
            
            // Ход полиции (простой ИИ)
            function policeMove() {
                gameState.policePos.forEach((policePos, index) => {
                    // Простой ИИ: двигаемся в сторону игрока
                    const directions = [];
                    
                    // Определяем предпочтительное направление
                    if (policePos.x < gameState.playerPos.x) directions.push('right');
                    else if (policePos.x > gameState.playerPos.x) directions.push('left');
                    
                    if (policePos.y < gameState.playerPos.y) directions.push('down');
                    else if (policePos.y > gameState.playerPos.y) directions.push('up');
                    
                    // Пробуем двигаться в предпочтительном направлении
                    for (const dir of directions) {
                        const newPos = calculateNewPosition(policePos, dir);
                        if (isValidMove(newPos)) {
                            gameState.policePos[index] = newPos;
                            break;
                        }
                    }
                    
                    // Если не смогли двигаться к игроку, делаем случайный ход
                    if (gameState.policePos[index] === policePos) {
                        const possibleDirections = ['up', 'down', 'left', 'right'];
                        const shuffled = possibleDirections.sort(() => 0.5 - Math.random());
                        
                        for (const dir of shuffled) {
                            const newPos = calculateNewPosition(policePos, dir);
                            if (isValidMove(newPos)) {
                                gameState.policePos[index] = newPos;
                                break;
                            }
                        }
                    }
                });
                
                render();
            }
            
            // Завершение игры
            function endGame(won) {
                gameState.gameOver = true;
                gameState.isMoving = false;
                
                if (won) {
                    messageDisplay.textContent = `Победа! Вы ушли от погони за ${gameState.turns} ходов!`;
                } else {
                    messageDisplay.textContent = `Игра окончена! Вас поймали через ${gameState.turns} ходов.`;
                }
                
                btnStart.textContent = 'Играть снова';
                btnStart.disabled = false;
            }
            
            // Начало игры
            function startGame() {
                initBoard();
                initPositions();
                render();
                
                gameState.isMoving = true;
                gameState.gameOver = false;
                
                btnStart.textContent = 'Игра идет...';
                btnStart.disabled = true;
                
                // Если начинаем на перекрестке, ждем выбора направления
                if (isIntersection(gameState.playerPos)) {
                    waitAtIntersection().then(() => {
                        policeMove();
                    });
                }
            }
            
            // Обработчики кнопок
            btnUp.addEventListener('click', () => {
                if (gameState.playerDirection !== 'up') {
                    playerMove('forward');
                }
            });
            
            btnForward.addEventListener('click', () => playerMove('forward'));
            btnLeft.addEventListener('click', () => playerMove('left'));
            btnRight.addEventListener('click', () => playerMove('right'));
            
            btnStart.addEventListener('click', startGame);
            
            // Инициализация
            initBoard();
            initPositions();
            render();
            
            // Для Telegram Web App
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.expand();
                Telegram.WebApp.enableClosingConfirmation();
            }
        });
    </script>
</body>
</html>