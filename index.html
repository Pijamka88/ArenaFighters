<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–æ–Ω–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
            color: #333;
        }
        #game-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #city-map {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            gap: 2px;
            background-color: #333;
            margin: 20px 0;
            height: 400px;
            position: relative;
        }
        .road {
            background-color: #555;
        }
        .intersection {
            background-color: #777;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .traffic-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin: 1px;
        }
        .red {
            background-color: red;
        }
        .green {
            background-color: green;
        }
        .player {
            color: blue;
            font-weight: bold;
            position: absolute;
            transform: translate(-50%, -50%);
        }
        .police {
            color: red;
            font-weight: bold;
            position: absolute;
            transform: translate(-50%, -50%);
        }
        #controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #dice-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        #dice {
            font-size: 24px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #dice-result {
            font-size: 24px;
            font-weight: bold;
        }
        #direction-buttons {
            display: none;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }
        .direction-btn {
            padding: 10px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        #menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .menu-btn {
            padding: 10px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #game-screen {
            display: none;
        }
        #game-over {
            display: none;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: red;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="menu">
            <h1>–ì–æ–Ω–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É</h1>
            <button class="menu-btn" id="start-btn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
            <button class="menu-btn" id="rules-btn">–ü—Ä–∞–≤–∏–ª–∞</button>
        </div>

        <div id="game-screen">
            <div id="stats">
                <div>–•–æ–¥—ã: <span id="moves-counter">0</span></div>
                <div>–ü–æ–ª–∏—Ü–∏—è: <span id="police-distance">-</span></div>
            </div>
            
            <div id="city-map"></div>
            
            <div id="game-over">–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê!</div>
            
            <div id="controls">
                <div id="dice-container">
                    <button id="dice">–ë—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫</button>
                    <div id="dice-result">-</div>
                </div>
                
                <div id="direction-buttons">
                    <button class="direction-btn" id="left-btn">‚Üê –í–ª–µ–≤–æ</button>
                    <button class="direction-btn" id="straight-btn">–ü—Ä—è–º–æ</button>
                    <button class="direction-btn" id="right-btn">–í–ø—Ä–∞–≤–æ ‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game state
        const gameState = {
            moves: 0,
            playerPos: {x: 4, y: 4},
            playerDirection: 'right',
            policePositions: [],
            policeDirections: [],
            currentDice: 0,
            remainingSteps: 0,
            gameActive: false,
            currentIntersection: null,
            roads: {},
            trafficLights: {}
        };

        // DOM elements
        const menuScreen = document.getElementById('menu');
        const gameScreen = document.getElementById('game-screen');
        const startBtn = document.getElementById('start-btn');
        const rulesBtn = document.getElementById('rules-btn');
        const cityMap = document.getElementById('city-map');
        const diceBtn = document.getElementById('dice');
        const diceResult = document.getElementById('dice-result');
        const directionButtons = document.getElementById('direction-buttons');
        const leftBtn = document.getElementById('left-btn');
        const straightBtn = document.getElementById('straight-btn');
        const rightBtn = document.getElementById('right-btn');
        const movesCounter = document.getElementById('moves-counter');
        const policeDistance = document.getElementById('police-distance');
        const gameOverDiv = document.getElementById('game-over');

        // Initialize the game
        function initGame() {
            // Create city map (9x9 grid)
            cityMap.innerHTML = '';
            
            // Generate roads and intersections
            gameState.roads = {};
            gameState.trafficLights = {};
            
            for (let y = 0; y < 9; y++) {
                for (let x = 0; x < 9; x++) {
                    const cell = document.createElement('div');
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    
                    // Intersections are at even coordinates (0, 2, 4, 6, 8)
                    if (x % 2 === 0 && y % 2 === 0) {
                        cell.className = 'intersection';
                        
                        // Add traffic light (random color)
                        const lightColor = Math.random() > 0.5 ? 'green' : 'red';
                        const light = document.createElement('div');
                        light.className = `traffic-light ${lightColor}`;
                        cell.appendChild(light);
                        
                        gameState.trafficLights[`${x},${y}`] = lightColor;
                    } else if (x % 2 === 0 || y % 2 === 0) {
                        cell.className = 'road';
                        gameState.roads[`${x},${y}`] = true;
                    }
                    
                    cityMap.appendChild(cell);
                }
            }
            
            // Set initial player position
            gameState.playerPos = {x: 4, y: 4};
            gameState.playerDirection = 'right';
            gameState.moves = 0;
            movesCounter.textContent = '0';
            
            // Initialize police positions (in corners)
            const corners = [
                {x: 0, y: 0},
                {x: 8, y: 0},
                {x: 0, y: 8},
                {x: 8, y: 8}
            ];
            
            // Shuffle corners and pick 2
            const shuffledCorners = [...corners].sort(() => Math.random() - 0.5);
            gameState.policePositions = shuffledCorners.slice(0, 2);
            gameState.policeDirections = ['right', 'left'].sort(() => Math.random() - 0.5);
            
            // Reset game state
            gameState.currentDice = 0;
            gameState.remainingSteps = 0;
            gameState.gameActive = true;
            gameState.currentIntersection = null;
            
            // Hide direction buttons and game over
            directionButtons.style.display = 'none';
            gameOverDiv.style.display = 'none';
            
            // Render all elements
            render();
        }

        // Render game state
        function render() {
            // Clear previous positions
            const oldElements = document.querySelectorAll('.player, .police');
            oldElements.forEach(el => el.remove());
            
            // Render player
            const playerElement = document.createElement('div');
            playerElement.className = 'player';
            playerElement.textContent = 'üöó';
            playerElement.style.left = `${(gameState.playerPos.x / 8) * 100}%`;
            playerElement.style.top = `${(gameState.playerPos.y / 8) * 100}%`;
            cityMap.appendChild(playerElement);
            
            // Render police
            gameState.policePositions.forEach((pos, idx) => {
                const policeElement = document.createElement('div');
                policeElement.className = 'police';
                policeElement.textContent = 'üöì';
                policeElement.style.left = `${(pos.x / 8) * 100}%`;
                policeElement.style.top = `${(pos.y / 8) * 100}%`;
                cityMap.appendChild(policeElement);
            });
            
            // Update police distance
            updatePoliceDistance();
        }

        // Update police distance display
        function updatePoliceDistance() {
            if (gameState.policePositions.length === 0) return;
            
            const distances = gameState.policePositions.map(police => {
                return Math.abs(police.x - gameState.playerPos.x) + Math.abs(police.y - gameState.playerPos.y);
            });
            
            const minDistance = Math.min(...distances);
            policeDistance.textContent = minDistance;
            
            // Check if police caught the player
            if (minDistance === 0) {
                endGame(false);
            }
        }

        // Roll dice
        function rollDice() {
            if (!gameState.gameActive) return;
            
            const result = Math.floor(Math.random() * 6) + 1;
            diceResult.textContent = result;
            gameState.currentDice = result;
            gameState.remainingSteps = result;
            
            diceBtn.disabled = true;
            
            // Start moving
            movePlayer();
        }

        // Move player
        function movePlayer() {
            if (gameState.remainingSteps <= 0) {
                // Player reached intersection or finished moving
                if (isAtIntersection(gameState.playerPos)) {
                    showDirectionButtons();
                } else {
                    // Police move after player
                    movePolice();
                    diceBtn.disabled = false;
                }
                return;
            }
            
            // Check if next position is valid
            const nextPos = getNextPosition(gameState.playerPos, gameState.playerDirection);
            
            if (isValidPosition(nextPos)) {
                // Check for red traffic light
                if (isAtIntersection(nextPos) && gameState.remainingSteps > 1) {
                    const lightColor = gameState.trafficLights[`${nextPos.x},${nextPos.y}`];
                    if (lightColor === 'red') {
                        // Stop at red light
                        gameState.remainingSteps = 0;
                        gameState.playerPos = nextPos;
                        render();
                        setTimeout(movePlayer, 500);
                        return;
                    }
                }
                
                // Move to next position
                gameState.playerPos = nextPos;
                gameState.remainingSteps--;
                gameState.moves++;
                movesCounter.textContent = gameState.moves;
                
                render();
                setTimeout(movePlayer, 300);
            } else {
                // Hit a wall or invalid position, stop moving
                gameState.remainingSteps = 0;
                movePlayer();
            }
        }

        // Move police cars
        function movePolice() {
            gameState.policePositions.forEach((pos, idx) => {
                // Police always moves toward player
                const dx = gameState.playerPos.x - pos.x;
                const dy = gameState.playerPos.y - pos.y;
                
                // Decide direction based on distance to player
                let direction;
                if (Math.abs(dx) > Math.abs(dy)) {
                    direction = dx > 0 ? 'right' : 'left';
                } else {
                    direction = dy > 0 ? 'down' : 'up';
                }
                
                // Try to move in chosen direction
                const nextPos = getNextPosition(pos, direction);
                if (isValidPosition(nextPos)) {
                    gameState.policePositions[idx] = nextPos;
                    gameState.policeDirections[idx] = direction;
                } else {
                    // If can't move, try alternative directions
                    const directions = ['up', 'down', 'left', 'right'];
                    for (const dir of directions) {
                        const altPos = getNextPosition(pos, dir);
                        if (isValidPosition(altPos)) {
                            gameState.policePositions[idx] = altPos;
                            gameState.policeDirections[idx] = dir;
                            break;
                        }
                    }
                }
            });
            
            render();
            
            // Check if police caught the player
            updatePoliceDistance();
        }

        // Show direction buttons at intersection
        function showDirectionButtons() {
            gameState.currentIntersection = {...gameState.playerPos};
            directionButtons.style.display = 'flex';
        }

        // Handle direction selection
        function selectDirection(newDirection) {
            directionButtons.style.display = 'none';
            
            // Change player direction based on choice
            const directions = ['up', 'right', 'down', 'left'];
            const currentIdx = directions.indexOf(gameState.playerDirection);
            
            let newIdx;
            if (newDirection === 'left') {
                newIdx = (currentIdx - 1 + 4) % 4;
            } else if (newDirection === 'right') {
                newIdx = (currentIdx + 1) % 4;
            } else {
                // Straight - keep same direction
                newIdx = currentIdx;
            }
            
            gameState.playerDirection = directions[newIdx];
            
            // Continue moving if there are remaining steps
            if (gameState.remainingSteps > 0) {
                movePlayer();
            } else {
                // Police move after player
                movePolice();
                diceBtn.disabled = false;
            }
        }

        // Check if position is at intersection
        function isAtIntersection(pos) {
            return pos.x % 2 === 0 && pos.y % 2 === 0;
        }

        // Check if position is valid (on road or intersection)
        function isValidPosition(pos) {
            if (pos.x < 0 || pos.x > 8 || pos.y < 0 || pos.y > 8) return false;
            return gameState.roads[`${pos.x},${pos.y}`] || isAtIntersection(pos);
        }

        // Get next position based on current position and direction
        function getNextPosition(pos, direction) {
            const newPos = {...pos};
            
            switch (direction) {
                case 'up':
                    newPos.y--;
                    break;
                case 'down':
                    newPos.y++;
                    break;
                case 'left':
                    newPos.x--;
                    break;
                case 'right':
                    newPos.x++;
                    break;
            }
            
            return newPos;
        }

        // End the game
        function endGame(won) {
            gameState.gameActive = false;
            gameOverDiv.textContent = won ? '–ü–û–ë–ï–î–ê! –í—ã —É—à–ª–∏ –æ—Ç –ø–æ–≥–æ–Ω–∏!' : '–ü–û–†–ê–ñ–ï–ù–ò–ï! –í–∞—Å –ø–æ–π–º–∞–ª–∞ –ø–æ–ª–∏—Ü–∏—è!';
            gameOverDiv.style.display = 'block';
            diceBtn.disabled = true;
            directionButtons.style.display = 'none';
            
            // Show menu button after delay
            setTimeout(() => {
                const backToMenu = document.createElement('button');
                backToMenu.className = 'menu-btn';
                backToMenu.textContent = '–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é';
                backToMenu.onclick = () => {
                    gameScreen.style.display = 'none';
                    menuScreen.style.display = 'block';
                };
                gameOverDiv.appendChild(document.createElement('br'));
                gameOverDiv.appendChild(backToMenu);
            }, 1000);
        }

        // Event listeners
        startBtn.addEventListener('click', () => {
            menuScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            initGame();
        });

        rulesBtn.addEventListener('click', () => {
            alert(`–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã:
1. –í—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ —Å–∏–Ω–µ–π –º–∞—à–∏–Ω–æ–π, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤ —Ü–µ–Ω—Ç—Ä–µ –≥–æ—Ä–æ–¥–∞.
2. –î–≤–µ –ø–æ–ª–∏—Ü–µ–π—Å–∫–∏–µ –º–∞—à–∏–Ω—ã (–∫—Ä–∞—Å–Ω—ã–µ) –Ω–∞—á–∏–Ω–∞—é—Ç –≤ —É–≥–ª–∞—Ö –≥–æ—Ä–æ–¥–∞ –∏ –ø—Ä–µ—Å–ª–µ–¥—É—é—Ç –≤–∞—Å.
3. –ë—Ä–æ—Å–∞–π—Ç–µ –∫—É–±–∏–∫, —á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –Ω–∞ —Å–∫–æ–ª—å–∫–æ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –¥–æ—Ä–æ–≥–∏ –≤—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å—Å—è.
4. –ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞—Ö (–≥–¥–µ –µ—Å—Ç—å —Å–≤–µ—Ç–æ—Ñ–æ—Ä—ã) –≤—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è.
5. –ï—Å–ª–∏ —Å–≤–µ—Ç–æ—Ñ–æ—Ä –∫—Ä–∞—Å–Ω—ã–π - –≤—ã –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç–µ—Å—å, –ø–æ–ª–∏—Ü–∏—è –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.
6. –¶–µ–ª—å - —É–π—Ç–∏ –æ—Ç –ø–æ–≥–æ–Ω–∏, –Ω–µ –¥–∞–≤–∞—è –ø–æ–ª–∏—Ü–∏–∏ –≤–∞—Å –ø–æ–π–º–∞—Ç—å.
7. –ß–µ–º –¥–æ–ª—å—à–µ –≤—ã –¥–µ—Ä–∂–∏—Ç–µ—Å—å, —Ç–µ–º –ª—É—á—à–µ –≤–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç!`);
        });

        diceBtn.addEventListener('click', rollDice);

        leftBtn.addEventListener('click', () => selectDirection('left'));
        straightBtn.addEventListener('click', () => selectDirection('straight'));
        rightBtn.addEventListener('click', () => selectDirection('right'));

        // Initialize
        initGame();
    </script>
</body>
</html>