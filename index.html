<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sky Ranch Showdown</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --main-color: #FF6B6B;
            --accent-color: #4ECDC4;
            --dark-bg: #2D3047;
            --light-text: #FFE66D;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: none;
            font-family: 'Luckiest Guy', cursive;
            background: var(--dark-bg);
            color: white;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        /* HUD Styles */
        #hud {
            position: fixed;
            top: 15px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
            pointer-events: none;
            z-index: 50;
        }

        .hud-item {
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 15px;
            border: 3px solid var(--light-text);
            box-shadow: 0 0 10px rgba(255,230,109,0.3);
            font-size: 1.2em;
        }

        /* Menu System */
        .window {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(45,48,71,0.95);
            padding: 30px 50px;
            border-radius: 25px;
            border: 3px solid var(--light-text);
            box-shadow: 0 0 25px rgba(255,230,109,0.4);
            z-index: 1000;
            display: none;
        }

        .window.active {
            display: block;
        }

        .window h2 {
            color: var(--light-text);
            text-align: center;
            margin: 0 0 20px 0;
        }

        .leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .leaderboard-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }

        /* Buttons */
        .btn {
            padding: 15px 30px;
            font-size: 1.2em;
            background: linear-gradient(45deg, var(--main-color), var(--accent-color));
            border: none;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: block;
            width: 100%;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--accent-color);
        }

        /* Crosshair */
        .crosshair {
            position: absolute;
            width: 40px;
            height: 40px;
            pointer-events: none;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="%234ECDC4" stroke-width="4"/><path d="M50 20V50M50 80V50M20 50H50M80 50H50" stroke="%23FF6B6B" stroke-width="4"/></svg>');
            background-size: contain;
            filter: drop-shadow(0 0 5px rgba(78,205,196,0.7));
            z-index: 500;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Main Menu -->
    <div class="window" id="mainMenu">
        <h1>ðŸ›¸ COW INVASION ðŸ‘½</h1>
        <button class="btn" id="startBtn">LAUNCH</button>
        <button class="btn" id="howToBtn">HOW TO PLAY</button>
        <button class="btn" id="leaderboardBtn">LEADERBOARD</button>
    </div>

    <!-- Leaderboard Window -->
    <div class="window" id="leaderboardWindow">
        <h2>CYBER LEADERBOARD</h2>
        <ul class="leaderboard-list" id="leaderboardList"></ul>
        <button class="btn" onclick="closeAllWindows()">CLOSE</button>
    </div>

    <!-- HUD Elements -->
    <div id="hud">
        <div class="hud-item">
            SCORE: <span id="score">0</span>
        </div>
        <div class="hud-item">
            LIVES: <span id="lives">3</span>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>
    <div class="crosshair"></div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let gameState = null;

        // Initialize Game
        function initGame() {
            gameState = {
                targets: [],
                score: 0,
                lives: 3,
                ammo: 10,
                isPlaying: false,
                crosshair: { x: 0, y: 0 },
                lastSpawn: 0,
                gameTime: 60000,
                reloading: false,
                cowTypes: [
                    { speed: 2, color: '#FF6B6B', pattern: 'linear', score: 20, radius: 25 },
                    { speed: 3, color: '#4ECDC4', pattern: 'sinus', score: 30, radius: 20 },
                    { speed: 4, color: '#FFE66D', pattern: 'zigzag', score: 40, radius: 30 }
                ],
                leaderboard: JSON.parse(localStorage.getItem('leaderboard')) || Array(10).fill(0)
            };
        }

        // Window Management
        function showWindow(id) {
            document.querySelectorAll('.window').forEach(w => w.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function closeAllWindows() {
            document.querySelectorAll('.window').forEach(w => w.classList.remove('active'));
        }

        // Environment Drawing
        function drawTree(x, baseY) {
            const trunkHeight = 80 + Math.random() * 80;
            const trunkWidth = 15 + Math.random() * 10;
            const canopySize = 40 + Math.random() * 40;
            
            // Trunk
            ctx.fillStyle = `hsl(${30 + Math.random() * 10}, 50%, 30%)`;
            ctx.fillRect(x, baseY - trunkHeight, trunkWidth, trunkHeight);
            
            // Canopy
            ctx.beginPath();
            ctx.arc(x + trunkWidth/2, baseY - trunkHeight - canopySize/2, canopySize, 0, Math.PI * 2);
            ctx.fillStyle = `hsl(${100 + Math.random() * 30}, 70%, 40%)`;
            ctx.fill();
            
            // Decorations
            ctx.strokeStyle = 'rgba(0,0,0,0.2)';
            ctx.lineWidth = 2;
            for(let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.arc(
                    x + trunkWidth/2 + Math.random() * canopySize - canopySize/2,
                    baseY - trunkHeight - canopySize/2 + Math.random() * canopySize - canopySize/2,
                    3 + Math.random() * 3,
                    0, Math.PI * 2
                );
                ctx.stroke();
            }
        }

        function drawEnvironment() {
            // Ground
            ctx.fillStyle = '#2d5a27';
            ctx.fillRect(0, canvas.height - 100, canvas.width, 100);
            
            // Trees
            for(let i = 0; i < 8; i++) {
                drawTree(i * (canvas.width / 7) + 30, canvas.height - 100);
            }
        }

        // Cow Drawing and Logic
        function createFlyingCow() {
            const type = Math.floor(Math.random() * gameState.cowTypes.length);
            return {
                x: Math.random() < 0.5 ? -80 : canvas.width + 80,
                y: Math.random() * (canvas.height * 0.7),
                type: type,
                speed: gameState.cowTypes[type].speed,
                direction: Math.random() < 0.5 ? 1 : -1,
                width: 60,
                height: 60,
                active: true,
                wingAngle: 0,
                hit: false,
                patternOffset: Math.random() * 100
            };
        }

        function drawCow(cow) {
            const type = gameState.cowTypes[cow.type];
            ctx.save();
            
            // Body
            ctx.fillStyle = type.color;
            ctx.beginPath();
            ctx.ellipse(
                cow.x + 30, 
                cow.y + 30, 
                30, 
                25, 
                Math.PI/4 * cow.direction, 
                0, 
                Math.PI * 2
            );
            ctx.fill();

            // Head
            ctx.beginPath();
            ctx.arc(
                cow.x + 30 + (25 * cow.direction), 
                cow.y + 25, 
                15, 
                0, 
                Math.PI * 2
            );
            ctx.fill();

            // Wings
            ctx.strokeStyle = '#FFE66D';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(cow.x + 30, cow.y + 30);
            ctx.lineTo(
                cow.x + 30 + Math.cos(cow.wingAngle) * 25 * cow.direction,
                cow.y + 30 + Math.sin(cow.wingAngle) * 10
            );
            ctx.stroke();

            ctx.restore();
        }

        // Game Logic
        function checkCollision(cow) {
            const type = gameState.cowTypes[cow.type];
            const centerX = cow.x + 30;
            const centerY = cow.y + 30;
            const distance = Math.hypot(
                gameState.crosshair.x - centerX,
                gameState.crosshair.y - centerY
            );
            return distance < type.radius;
        }

        function updateLeaderboard() {
            gameState.leaderboard.push(gameState.score);
            gameState.leaderboard = [...new Set(gameState.leaderboard)]
                .sort((a, b) => b - a)
                .slice(0, 10);
            localStorage.setItem('leaderboard', JSON.stringify(gameState.leaderboard));
            
            const list = document.getElementById('leaderboardList');
            list.innerHTML = gameState.leaderboard
                .map((score, i) => `<li class="leaderboard-item">${i+1}. ${score}</li>`)
                .join('');
        }

        function gameLoop(timestamp) {
            if (!gameState.isPlaying) return;

            // Spawn cows
            if (timestamp - gameState.lastSpawn > 1500 && gameState.targets.length < 4) {
                gameState.targets.push(createFlyingCow());
                gameState.lastSpawn = timestamp;
            }

            // Update cows
            gameState.targets = gameState.targets.filter(cow => {
                // Movement patterns
                switch(gameState.cowTypes[cow.type].pattern) {
                    case 'sinus':
                        cow.y += Math.sin(timestamp * 0.002 + cow.patternOffset) * 0.5;
                        break;
                    case 'zigzag':
                        cow.x += Math.sin(timestamp * 0.003) * 0.7;
                        break;
                }

                cow.x += cow.speed * cow.direction;
                cow.wingAngle = Math.sin(timestamp * 0.01) * 0.5;

                // Check escape
                if ((cow.direction === 1 && cow.x > canvas.width + 100) ||
                    (cow.direction === -1 && cow.x < -100)) {
                    if(cow.active) gameState.lives--;
                    if(gameState.lives <= 0) endGame();
                    return false;
                }
                return true;
            });

            // Update HUD
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('lives').textContent = gameState.lives;

            // Drawing
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawEnvironment();
            gameState.targets.forEach(drawCow);

            requestAnimationFrame(gameLoop);
        }

        function handleShoot() {
            if (!gameState.isPlaying || gameState.ammo <= 0 || gameState.reloading) return;

            gameState.ammo--;
            let hit = false;

            gameState.targets.forEach(cow => {
                if (checkCollision(cow)) {
                    cow.active = false;
                    gameState.score += gameState.cowTypes[cow.type].score;
                    hit = true;
                }
            });

            if (gameState.ammo <= 0) {
                gameState.reloading = true;
                setTimeout(() => {
                    gameState.ammo = 10;
                    gameState.reloading = false;
                }, 2000);
            }
        }

        function endGame() {
            gameState.isPlaying = false;
            updateLeaderboard();
            showWindow('mainMenu');
            document.querySelector('.crosshair').style.display = 'none';
        }

        // Event Listeners
        document.getElementById('startBtn').addEventListener('click', () => {
            initGame();
            document.querySelector('.crosshair').style.display = 'block';
            closeAllWindows();
            
            gameState.isPlaying = true;
            setTimeout(endGame, gameState.gameTime);
            requestAnimationFrame(gameLoop);
        });

        document.getElementById('howToBtn').addEventListener('click', () => {
            alert(`HOW TO PLAY:\n- Shoot flying cows\n- Different colors = different points\n- 3 lives\n- 60 seconds`);
        });

        document.getElementById('leaderboardBtn').addEventListener('click', () => {
            showWindow('leaderboardWindow');
        });

        canvas.addEventListener('mousemove', e => {
            const rect = canvas.getBoundingClientRect();
            gameState.crosshair.x = e.clientX - rect.left;
            gameState.crosshair.y = e.clientY - rect.top;
            document.querySelector('.crosshair').style.transform = 
                `translate(${e.clientX - 20}px, ${e.clientY - 20}px)`;
        });

        canvas.addEventListener('mousedown', handleShoot);
        canvas.addEventListener('touchstart', handleShoot);

        // Initial Setup
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        initGame();
        showWindow('mainMenu');

        // Telegram Web App Integration
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
    </script>
</body>
</html>