<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Chocolate Arena</title>
    <style>
        body {
            margin: 0;
            background: #3D2B1F;
            color: #D2691E;
            font-family: 'Arial', sans-serif;
            text-align: center;
            overflow: hidden;
        }

        #mainMenu {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            margin-top: 50px;
        }

        .menuBtn {
            background: #6B4423;
            border: 2px solid #8B4513;
            color: #DEB887;
            padding: 15px;
            font-size: 1.2em;
            cursor: pointer;
            border-radius: 10px;
            transition: transform 0.2s;
        }

        .menuBtn:hover {
            transform: scale(1.05);
        }

        #gameArea {
            display: none;
            position: relative;
            height: 70vh;
            margin: 20px;
        }

        .character {
            position: absolute;
            font-size: 4em;
            bottom: 20px;
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
        }

        .healthBar {
            position: absolute;
            width: 100px;
            height: 10px;
            background: #FF0000;
            border: 2px solid #8B0000;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
        }

        .health {
            height: 100%;
            background: #00FF00;
            transition: width 0.3s;
        }

        #player {
            left: 20%;
        }

        #enemy {
            right: 20%;
        }

        #stats {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
        }

        #shop {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #6B4423;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #8B4513;
        }

        .attack-animation {
            animation: attack 0.3s;
        }

        @keyframes attack {
            50% { transform: translateY(-20px); }
        }

        @media (max-width: 600px) {
            .character {
                font-size: 3em;
            }
            .menuBtn {
                padding: 10px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div id="mainMenu">
        <button class="menuBtn" onclick="startGame()">Start Battle</button>
        <button class="menuBtn" onclick="showShop()">Upgrade Hero</button>
        <div id="stats">
            Level: <span id="level">1</span><br>
            Gold: <span id="gold">0</span><br>
            Wins: <span id="wins">0</span>
        </div>
    </div>

    <div id="gameArea">
        <div id="player" class="character">üó°Ô∏è</div>
        <div id="enemy" class="character">üëπ</div>
    </div>

    <div id="shop">
        <h3>Upgrade Hero</h3>
        <button onclick="upgrade('attack')">Attack (+5) - 50g</button>
        <button onclick="upgrade('health')">Health (+50) - 50g</button>
        <button onclick="upgrade('crit')">Crit Chance (+2%) - 50g</button>
        <button onclick="hideShop()">Close</button>
    </div>

<script>
    let player = {
        attack: 10,
        maxHealth: 100,
        health: 100,
        crit: 5,
        level: 1,
        gold: 0,
        wins: 0
    };

    let currentEnemy = null;
    let isBoss = false;
    let gameLoop = null;

    function saveGame() {
        localStorage.setItem('save', JSON.stringify(player));
    }

    function loadGame() {
        let save = localStorage.getItem('save');
        if(save) player = JSON.parse(save);
        updateStats();
    }

    function updateStats() {
        document.getElementById('level').textContent = player.level;
        document.getElementById('gold').textContent = player.gold;
        document.getElementById('wins').textContent = player.wins;
    }

    function startGame() {
        document.getElementById('mainMenu').style.display = 'none';
        document.getElementById('gameArea').style.display = 'block';
        spawnEnemy();
        startBattle();
    }

    function spawnEnemy() {
        isBoss = player.wins > 0 && player.wins % 5 === 0;
        currentEnemy = {
            attack: isBoss ? player.attack * 2 : player.attack + Math.floor(player.wins/2),
            maxHealth: isBoss ? player.maxHealth * 3 : player.maxHealth + player.wins * 20,
            health: isBoss ? player.maxHealth * 3 : player.maxHealth + player.wins * 20,
            name: isBoss ? 'üëø' : 'üëπ'
        };
        document.getElementById('enemy').textContent = currentEnemy.name;
        updateHealth('enemy');
    }

    function startBattle() {
        gameLoop = setInterval(() => {
            // Player attack
            let damage = calculateDamage(player, currentEnemy);
            currentEnemy.health -= damage;
            updateHealth('enemy');
            document.getElementById('player').classList.add('attack-animation');
            
            if(currentEnemy.health <= 0) {
                endBattle(true);
                return;
            }

            // Enemy attack
            setTimeout(() => {
                damage = calculateDamage(currentEnemy, player);
                player.health -= damage;
                updateHealth('player');
                document.getElementById('enemy').classList.add('attack-animation');
                
                if(player.health <= 0) {
                    endBattle(false);
                }
            }, 300);

            setTimeout(() => {
                document.getElementById('player').classList.remove('attack-animation');
                document.getElementById('enemy').classList.remove('attack-animation');
            }, 500);
        }, 1000);
    }

    function calculateDamage(attacker, defender) {
        let crit = Math.random() < attacker.crit / 100;
        return Math.max(1, attacker.attack * (crit ? 2 : 1) - Math.floor(defender.attack/3));
    }

    function updateHealth(target) {
        let health = target === 'player' ? player : currentEnemy;
        let bar = document.querySelector(`#${target} .health`);
        let percent = (health.health / health.maxHealth * 100).toFixed(0);
        bar.style.width = percent + '%';
    }

    function endBattle(victory) {
        clearInterval(gameLoop);
        if(victory) {
            player.gold += isBoss ? 200 : 50;
            player.wins++;
            saveGame();
            updateStats();
            spawnEnemy();
            startBattle();
        } else {
            alert('Defeat!');
            document.getElementById('mainMenu').style.display = 'flex';
            document.getElementById('gameArea').style.display = 'none';
            player.health = player.maxHealth;
        }
    }

    function showShop() {
        document.getElementById('shop').style.display = 'block';
    }

    function hideShop() {
        document.getElementById('shop').style.display = 'none';
    }

    function upgrade(stat) {
        if(player.gold < 50) return;
        player.gold -= 50;
        player[stat] += stat === 'attack' ? 5 : stat === 'health' ? 50 : 2;
        if(stat === 'health') player.health = player.maxHealth;
        player.level++;
        saveGame();
        updateStats();
    }

    // Init
    loadGame();
    player.health = player.maxHealth;
    document.getElementById('player').innerHTML = '<div class="healthBar"><div class="health"></div></div>üó°Ô∏è';
    document.getElementById('enemy').innerHTML = '<div class="healthBar"><div class="health"></div></div>üëπ';

    // Telegram Web Apps integration
    Telegram.WebApp.ready();
    Telegram.WebApp.MainButton.setText('OPEN MENU').show().onClick(() => {
        document.getElementById('mainMenu').style.display = 'flex';
        document.getElementById('gameArea').style.display = 'none';
        clearInterval(gameLoop);
    });
</script>
</body>
</html>