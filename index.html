<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Побег от полиции</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            touch-action: manipulation;
        }
        
        #game-container {
            position: relative;
            width: 300px;
            height: 300px;
            background-color: #333;
            margin-bottom: 20px;
        }
        
        #game-map {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .road {
            position: absolute;
            background-color: #555;
        }
        
        .road-horizontal {
            height: 20px;
            width: 100%;
        }
        
        .road-vertical {
            width: 20px;
            height: 100%;
        }
        
        .intersection {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #777;
            z-index: 2;
        }
        
        .traffic-light {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            z-index: 3;
        }
        
        .traffic-light-red {
            background-color: red;
        }
        
        .traffic-light-green {
            background-color: green;
        }
        
        .building {
            position: absolute;
            background-color: #444;
            z-index: 1;
        }
        
        .car {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 2px;
            z-index: 4;
            transition: all 0.3s ease;
        }
        
        #player {
            background-color: #00f;
        }
        
        .police {
            background-color: #f00;
        }
        
        #controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        #direction-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
        }
        
        button {
            padding: 10px 15px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            min-width: 80px;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        #timer {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            display: none;
        }
        
        #game-over h2 {
            margin-bottom: 20px;
        }
        
        #restart-btn {
            background-color: #4CAF50;
        }
    </style>
</head>
<body>
    <h1>Побег от полиции</h1>
    <div id="timer">Ходов: 0</div>
    <div id="game-container">
        <div id="game-map"></div>
        <div id="game-over">
            <h2 id="game-over-text">Игра окончена!</h2>
            <p id="score-text">Вы продержались: 0 ходов</p>
            <button id="restart-btn">Играть снова</button>
        </div>
    </div>
    <div id="controls">
        <div id="direction-buttons">
            <button id="left-btn" disabled>← Влево</button>
            <button id="straight-btn" disabled>Прямо</button>
            <button id="right-btn" disabled>→ Вправо</button>
        </div>
    </div>

    <script>
        // Игровые константы
        const MAP_SIZE = 300;
        const ROAD_WIDTH = 20;
        const INTERSECTION_SIZE = 20;
        const CAR_SIZE = 16;
        
        // Состояние игры
        let gameState = {
            player: { x: 0, y: 0, direction: 'right' },
            police: [
                { x: 0, y: 0, direction: 'right' },
                { x: 0, y: 0, direction: 'down' }
            ],
            turn: 0,
            gameOver: false,
            atIntersection: false,
            currentIntersection: null,
            trafficLights: {}
        };
        
        // DOM элементы
        const gameMap = document.getElementById('game-map');
        const playerCar = document.createElement('div');
        const policeCars = [
            document.createElement('div'),
            document.createElement('div')
        ];
        const leftBtn = document.getElementById('left-btn');
        const straightBtn = document.getElementById('straight-btn');
        const rightBtn = document.getElementById('right-btn');
        const timerElement = document.getElementById('timer');
        const gameOverScreen = document.getElementById('game-over');
        const gameOverText = document.getElementById('game-over-text');
        const scoreText = document.getElementById('score-text');
        const restartBtn = document.getElementById('restart-btn');
        
        // Инициализация игры
        function initGame() {
            gameState = {
                player: { x: 30, y: MAP_SIZE - 30, direction: 'up' },
                police: [
                    { x: MAP_SIZE - 30, y: 30, direction: 'left' },
                    { x: 30, y: 30, direction: 'down' }
                ],
                turn: 0,
                gameOver: false,
                atIntersection: false,
                currentIntersection: null,
                trafficLights: {}
            };
            
            // Очищаем карту
            gameMap.innerHTML = '';
            
            // Создаем дороги и здания
            createMap();
            
            // Создаем машины
            playerCar.id = 'player';
            playerCar.className = 'car';
            gameMap.appendChild(playerCar);
            
            for (let i = 0; i < policeCars.length; i++) {
                policeCars[i].className = 'car police';
                gameMap.appendChild(policeCars[i]);
            }
            
            // Обновляем отображение
            updateGame();
            
            // Сбрасываем UI
            timerElement.textContent = 'Ходов: 0';
            gameOverScreen.style.display = 'none';
            disableDirectionButtons();
        }
        
        // Создаем карту города
        function createMap() {
            // Горизонтальные дороги
            for (let y = 50; y < MAP_SIZE; y += 50) {
                const road = document.createElement('div');
                road.className = 'road road-horizontal';
                road.style.top = `${y - ROAD_WIDTH/2}px`;
                gameMap.appendChild(road);
            }
            
            // Вертикальные дороги
            for (let x = 50; x < MAP_SIZE; x += 50) {
                const road = document.createElement('div');
                road.className = 'road road-vertical';
                road.style.left = `${x - ROAD_WIDTH/2}px`;
                gameMap.appendChild(road);
            }
            
            // Перекрестки
            for (let x = 50; x < MAP_SIZE; x += 50) {
                for (let y = 50; y < MAP_SIZE; y += 50) {
                    const intersection = document.createElement('div');
                    intersection.className = 'intersection';
                    intersection.style.left = `${x - INTERSECTION_SIZE/2}px`;
                    intersection.style.top = `${y - INTERSECTION_SIZE/2}px`;
                    gameMap.appendChild(intersection);
                    
                    // Светофоры (случайно выбираем цвет)
                    const light = document.createElement('div');
                    light.className = `traffic-light traffic-light-${Math.random() > 0.5 ? 'red' : 'green'}`;
                    light.style.left = `${x - 3}px`;
                    light.style.top = `${y - 3}px`;
                    gameMap.appendChild(light);
                    
                    // Сохраняем состояние светофора
                    gameState.trafficLights[`${x},${y}`] = light.classList.contains('traffic-light-red') ? 'red' : 'green';
                }
            }
            
            // Здания
            const buildingPositions = [
                { left: 10, top: 10, width: 30, height: 30 },
                { left: 70, top: 10, width: 30, height: 30 },
                { left: 130, top: 10, width: 30, height: 30 },
                { left: 190, top: 10, width: 30, height: 30 },
                { left: 250, top: 10, width: 30, height: 30 },
                
                { left: 10, top: 70, width: 30, height: 30 },
                { left: 250, top: 70, width: 30, height: 30 },
                
                { left: 10, top: 130, width: 30, height: 30 },
                { left: 250, top: 130, width: 30, height: 30 },
                
                { left: 10, top: 190, width: 30, height: 30 },
                { left: 250, top: 190, width: 30, height: 30 },
                
                { left: 10, top: 250, width: 30, height: 30 },
                { left: 70, top: 250, width: 30, height: 30 },
                { left: 130, top: 250, width: 30, height: 30 },
                { left: 190, top: 250, width: 30, height: 30 },
                { left: 250, top: 250, width: 30, height: 30 }
            ];
            
            for (const pos of buildingPositions) {
                const building = document.createElement('div');
                building.className = 'building';
                building.style.left = `${pos.left}px`;
                building.style.top = `${pos.top}px`;
                building.style.width = `${pos.width}px`;
                building.style.height = `${pos.height}px`;
                gameMap.appendChild(building);
            }
        }
        
        // Обновляем отображение игры
        function updateGame() {
            // Обновляем позицию игрока
            playerCar.style.left = `${gameState.player.x - CAR_SIZE/2}px`;
            playerCar.style.top = `${gameState.player.y - CAR_SIZE/2}px`;
            
            // Обновляем позиции полиции
            for (let i = 0; i < gameState.police.length; i++) {
                policeCars[i].style.left = `${gameState.police[i].x - CAR_SIZE/2}px`;
                policeCars[i].style.top = `${gameState.police[i].y - CAR_SIZE/2}px`;
            }
            
            // Проверяем, находится ли игрок на перекрестке
            checkIntersection();
            
            // Проверяем условия окончания игры
            checkGameOver();
        }
        
        // Проверяем, находится ли игрок на перекрестке
        function checkIntersection() {
            gameState.atIntersection = false;
            gameState.currentIntersection = null;
            
            // Проверяем все перекрестки
            for (let x = 50; x < MAP_SIZE; x += 50) {
                for (let y = 50; y < MAP_SIZE; y += 50) {
                    // Если игрок рядом с центром перекрестка
                    if (Math.abs(gameState.player.x - x) < 5 && Math.abs(gameState.player.y - y) < 5) {
                        gameState.atIntersection = true;
                        gameState.currentIntersection = { x, y };
                        enableDirectionButtons();
                        return;
                    }
                }
            }
            
            disableDirectionButtons();
        }
        
        // Включаем кнопки выбора направления
        function enableDirectionButtons() {
            leftBtn.disabled = false;
            straightBtn.disabled = false;
            rightBtn.disabled = false;
        }
        
        // Отключаем кнопки выбора направления
        function disableDirectionButtons() {
            leftBtn.disabled = true;
            straightBtn.disabled = true;
            rightBtn.disabled = true;
        }
        
        // Двигаем игрока в выбранном направлении
        function movePlayer(directionChange) {
            if (gameState.gameOver || !gameState.atIntersection) return;
            
            // Изменяем направление игрока
            const directions = ['up', 'right', 'down', 'left'];
            let currentIndex = directions.indexOf(gameState.player.direction);
            
            if (directionChange === 'left') {
                currentIndex = (currentIndex - 1 + 4) % 4;
            } else if (directionChange === 'right') {
                currentIndex = (currentIndex + 1) % 4;
            }
            // Для 'straight' направление не меняем
            
            gameState.player.direction = directions[currentIndex];
            
            // Двигаем игрока вперед до следующего перекрестка
            moveCarToNextIntersection(gameState.player);
            
            // Увеличиваем счетчик ходов
            gameState.turn++;
            timerElement.textContent = `Ходов: ${gameState.turn}`;
            
            // Двигаем полицию
            movePolice();
            
            // Обновляем отображение
            updateGame();
        }
        
        // Двигаем машину до следующего перекрестка
        function moveCarToNextIntersection(car) {
            const step = 50; // Расстояние между перекрестками
            
            switch (car.direction) {
                case 'up':
                    car.y -= step;
                    break;
                case 'right':
                    car.x += step;
                    break;
                case 'down':
                    car.y += step;
                    break;
                case 'left':
                    car.x -= step;
                    break;
            }
            
            // Проверяем границы карты
            if (car.x < 0) car.x = 0;
            if (car.x > MAP_SIZE) car.x = MAP_SIZE;
            if (car.y < 0) car.y = 0;
            if (car.y > MAP_SIZE) car.y = MAP_SIZE;
        }
        
        // Двигаем полицейские машины
        function movePolice() {
            for (let i = 0; i < gameState.police.length; i++) {
                const police = gameState.police[i];
                
                // Простой ИИ для полиции
                // 1. Если полиция на перекрестке, выбираем направление
                let onIntersection = false;
                for (let x = 50; x < MAP_SIZE; x += 50) {
                    for (let y = 50; y < MAP_SIZE; y += 50) {
                        if (Math.abs(police.x - x) < 5 && Math.abs(police.y - y) < 5) {
                            onIntersection = true;
                            
                            // Выбираем направление, которое приближает к игроку
                            const dx = gameState.player.x - police.x;
                            const dy = gameState.player.y - police.y;
                            
                            // Проверяем светофор
                            const lightState = gameState.trafficLights[`${x},${y}`];
                            
                            if (lightState === 'red' && Math.random() > 0.3) {
                                // С вероятностью 70% останавливаемся на красный
                                break;
                            }
                            
                            if (Math.abs(dx) > Math.abs(dy)) {
                                police.direction = dx > 0 ? 'right' : 'left';
                            } else {
                                police.direction = dy > 0 ? 'down' : 'up';
                            }
                            
                            // Иногда выбираем случайное направление (чтобы не было слишком предсказуемо)
                            if (Math.random() < 0.2) {
                                const directions = ['up', 'right', 'down', 'left'];
                                police.direction = directions[Math.floor(Math.random() * 4)];
                            }
                            
                            break;
                        }
                    }
                    if (onIntersection) break;
                }
                
                // Двигаем полицию вперед
                moveCarToNextIntersection(police);
            }
        }
        
        // Проверяем условия окончания игры
        function checkGameOver() {
            // Проверяем столкновение с полицией
            for (const police of gameState.police) {
                if (Math.abs(gameState.player.x - police.x) < 10 && Math.abs(gameState.player.y - police.y) < 10) {
                    endGame(false);
                    return;
                }
            }
            
            // Проверяем выход за границы карты
            if (gameState.player.x <= 0 || gameState.player.x >= MAP_SIZE || 
                gameState.player.y <= 0 || gameState.player.y >= MAP_SIZE) {
                endGame(false);
                return;
            }
        }
        
        // Завершаем игру
        function endGame(success) {
            gameState.gameOver = true;
            
            if (success) {
                gameOverText.textContent = 'Победа!';
            } else {
                gameOverText.textContent = 'Вас поймали!';
            }
            
            scoreText.textContent = `Вы продержались: ${gameState.turn} ходов`;
            gameOverScreen.style.display = 'flex';
        }
        
        // Обработчики событий
        leftBtn.addEventListener('click', () => movePlayer('left'));
        straightBtn.addEventListener('click', () => movePlayer('straight'));
        rightBtn.addEventListener('click', () => movePlayer('right'));
        restartBtn.addEventListener('click', initGame);
        
        // Инициализируем игру при загрузке
        window.addEventListener('load', initGame);
        
        // Для Telegram Web Apps
        if (window.Telegram && window.Telegram.WebApp) {
            Telegram.WebApp.expand();
            Telegram.WebApp.enableClosingConfirmation();
        }
    </script>
</body>
</html>